<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title></title>
        <meta name="robots" content="noindex">


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="./theme/highlight.css">
        <link rel="stylesheet" href="./theme/mdbook-admonish.css">

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="welcome.html">Welcome</a></li><li class="chapter-item expanded affix "><li class="part-title">Introduction</li><li class="chapter-item expanded "><a href="tcg.html"><strong aria-hidden="true">1.</strong> Trading Card Games</a></li><li class="chapter-item expanded "><a href="tech-intro.html"><strong aria-hidden="true">2.</strong> The technology</a></li><li class="chapter-item expanded "><a href="intro.html"><strong aria-hidden="true">3.</strong> Overview of the code</a></li><li class="chapter-item expanded affix "><li class="part-title">Practice</li><li class="chapter-item expanded "><a href="adt.html"><strong aria-hidden="true">4.</strong> What is (in) a deck</a></li><li class="chapter-item expanded "><a href="validation.html"><strong aria-hidden="true">5.</strong> Law-abiding decks</a></li><li class="chapter-item expanded "><a href="build.html"><strong aria-hidden="true">6.</strong> Deck building</a></li><li class="chapter-item expanded "><a href="resilience.html"><strong aria-hidden="true">7.</strong> Deal with bad internet</a></li><li class="chapter-item expanded "><a href="par.html"><strong aria-hidden="true">8.</strong> Loading and saving</a></li><li class="chapter-item expanded "><a href="architecture.html"><strong aria-hidden="true">9.</strong> Better architecture</a></li><li class="chapter-item expanded "><a href="cmp.html"><strong aria-hidden="true">10.</strong> Nicer UI</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="latte">Latte</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="frappe">Frapp√©</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="macchiato">Macchiato</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mocha">Mocha</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="pok√©-fun-with-kotlin-and-arrow"><a class="header" href="#pok√©-fun-with-kotlin-and-arrow">Pok√©-Fun with Kotlin and Arrow</a></h1>
<p>Welcome! In this guide we (well, actually you) are going to work on an application to build decks for the Pok√©mon Trading Card Game (TCG). Each chapter roughly corresponds to a different functionality: loading decks, searching cards, and so on.</p>
<blockquote>
<p>The source code is available in <a href="https://github.com/serras/poke-fun">this repository</a>. Download or clone it, and you should be ready to go.</p>
</blockquote>
<p>This book assumes that you know your way around <a href="https://kotlinlang.org">Kotlin</a>, but previous experience with functional programming or <a href="https://arrow-kt.io">Arrow</a>, or with Compose Multiplatform, is not required.</p>
<div id="admonition-compose-is-multi-plaftorm" class="admonition admonish-note" role="note" aria-labelledby="admonition-compose-is-multi-plaftorm-title">
<div class="admonition-title">
<div id="admonition-compose-is-multi-plaftorm-title">
<p>Compose is multi-plaftorm</p>
</div>
<a class="admonition-anchor-link" href="welcome.html#admonition-compose-is-multi-plaftorm"></a>
</div>
<div>
<p>For ease of development, the provided skeleton is a desktop application. Using Compose Multiplatform you can easily make it run in Android or iOS devices, with minor modifications.</p>
</div>
</div>
<p>The starting point introduces the domain and the main components of the technology.</p>
<ul>
<li>If you have never heard of the Pok√©mon Trading Card Game or don't know the rules, start with the <a href="./tcg.html">introduction to the domain</a>;</li>
<li>If you are new to Amper or Compose Multiplatform, start with <a href="./tech-intro.html">the technology</a>,</li>
</ul>
<div id="admonition-built-with-amper" class="admonition admonish-warning" role="note" aria-labelledby="admonition-built-with-amper-title">
<div class="admonition-title">
<div id="admonition-built-with-amper-title">
<p>Built with Amper</p>
</div>
<a class="admonition-anchor-link" href="welcome.html#admonition-built-with-amper"></a>
</div>
<div>
<p>Pok√©-Fun uses <a href="https://github.com/JetBrains/amper">Amper</a> as build tool, as opposed to the most usual Gradle. In particular, you need to install the <a href="https://plugins.jetbrains.com/plugin/23076-amper">corresponding plug-in</a> if you are using IntelliJ or Android Studio.</p>
</div>
</div>
<p>Afterward, the <a href="./intro.html">overview</a> describes the main components of the given code.
The rest of the guide is divided into a series of more or less independent sections, so you can choose what you want to work on. Each section contains an introduction to one or more topics, and pointers to additional tutorials or documentation about them.</p>
<ul>
<li><a href="./adt.html">What is (in) a deck</a>: model data using data classes and sealed hierarchies;</li>
<li><a href="./validation.html">Law-abiding decks</a>: check that the deck follows the rules, and learn about <code>Raise</code> along the way;</li>
<li><a href="./build.html">Deck building</a>: design a good <code>ViewModel</code> using functional principles, and design undo/redo with actions-as-data;</li>
<li><a href="./resilience.html">Deal with bad internet</a>: improve the experience with <code>Schedule</code> and <code>CircuitBreaker</code>, and cache results using memoization;</li>
<li><a href="./par.html">Loading and saving</a>: store your work locally, and learn about parallel combinators in Arrow Fx;</li>
<li><a href="./architecture.html">Better architecture</a>: introduce resource management, and overall nicer design;</li>
<li><a href="./cmp.html">Nicer UI</a>: implement more visual feedback using Compose Multiplatform.</li>
</ul>
<div id="admonition-a-word-from-our-sponsor" class="admonition admonish-tip" role="note" aria-labelledby="admonition-a-word-from-our-sponsor-title">
<div class="admonition-title">
<div id="admonition-a-word-from-our-sponsor-title">
<p>A word from our sponsor</p>
</div>
<a class="admonition-anchor-link" href="welcome.html#admonition-a-word-from-our-sponsor"></a>
</div>
<div>
<p>Many of these sections complement the book <a href="https://leanpub.com/fp-ideas-kotlin">Functional Programming Ideas for the Curious Kotliner</a>.</p>
</div>
</div><div style="break-before: page; page-break-before: always;"></div><h1 id="trading-card-games"><a class="header" href="#trading-card-games">Trading Card Games</a></h1>
<p>The application in which we are going to work on, Pok√©-Fun, helps in the process of building decks for the Pok√©mon Trading Card Game (TCG). As usual in any software project, we first need to understand what all the words in the previous sentence mean; in other words, we need to dive into the <em>domain</em>.</p>
<p>In general, a <em>Trading Card Game</em> is a card game in which the set of cards is not fixed, as in P√≥ker or Mus. In the case of Pok√©mon TCG, every year more than 500 new cards are introduced. In order to play, each player chooses a subset of card; this is known as their <em>deck</em>. The <em>trading</em> in TCG comes from the fact that traditionally you get the cards you need by exchanging them with your friends.</p>
<p>Most TCGs, and Pok√©mon is no exception, place some implicit and explicit restrictions on how decks may be built. Explicit restrictions include, among others, that your deck must contain exactly 60 cards. Other restrictions are implicit in the rules of the game; for example, a Pok√©mon deck cannot function with at least one basic Pok√©mon.</p>
<p>Once again we find a bunch of terms from the domain, what DDD practitioners call the <em>Ubiquituous Language</em>, so let's dive a bit more. Pok√©mon cards are divided in three big groups.</p>
<div class="table-wrapper"><table><thead><tr><th></th><th></th></tr></thead><tbody>
<tr><td><img src="https://images.pokemontcg.io/svp/46_hires.png" alt="Bulbasaur" /></td><td><em>Pok√©mon</em> cards represent little monsters that fight against those of your opponent. Each Pok√©mon has one or more <em>attacks</em>, and <em>health points</em> (HP), which define how much damage they can take before fainting.</td></tr>
<tr><td><img src="https://images.pokemontcg.io/sve/1_hires.png" alt="Grass Energy" /></td><td><em>Energy</em> cards are needed to power the attacks of Pok√©mon.</td></tr>
<tr><td><img src="https://images.pokemontcg.io/sv2/183_hires.png" alt="Great Ball" /></td><td><em>Trainer</em> cards provide additional effects that you can use to help in the battle.</td></tr>
</tbody></table>
</div>
<p>Pok√©mon and energies also have a <em>type</em>. There are currently 8 different types in the Pok√©mon TCG ‚Äî grass <img src="images/grass.png" height="15px" />, fire <img src="images/fire.png" height="15px" />, water <img src="images/water.png" height="15px" />, lightning <img src="images/lightning.png" height="15px" />, fighting <img src="images/fighting.png" height="15px" />, psychic <img src="images/psychic.png" height="15px" />, metal <img src="images/metal.png" height="15px" />, darkness <img src="images/darkness.png" height="15px" />, and dragon <img src="images/dragon.png" height="15px" /> ‚Äî alongside a special colorless <img src="images/colorless.png" height="15px" /> type. In most cases a Pok√©mon of a certain type requires energy of the same type, but this is not a rule.</p>
<p>One key component of the Pok√©mon world is that the little monsters <em>evolve</em>, that is, the turn into bigger and more powerful creatures. In the TCG this is reflected by having to begin with <em>basic</em> Pok√©mon (hence the implicit requirement to have at least one in your deck), which then may turn into <em>stage 1</em>, and eventually in <em>stage 2</em>.</p>
<p>Apart from the type, one key attribute of cards is their <em>name</em>, since the rules have explicit restrictions on the amount of cards you can have with the same name. However, this does not mean that all cards with the same name are the same; for that reason each of them has an <em>identifier</em> to uniquely point to it.</p>
<div id="admonition-example" class="admonition admonish-example" role="note" aria-labelledby="admonition-example-title">
<div class="admonition-title">
<div id="admonition-example-title">
<p>Example</p>
</div>
<a class="admonition-anchor-link" href="tcg.html#admonition-example"></a>
</div>
<div>
<p>These are two different (happy) Oddish cards. Same name, different identifier, different attacks and HP.</p>
<p><img src="https://images.pokemontcg.io/sv3/1.png" alt="Oddish 1" /> <img src="https://images.pokemontcg.io/sv3pt5/43.png" alt="Oddish 2" /></p>
</div>
</div>
<p>This is enough for our purposes. If you are interested to learn how to play the game, check the <a href="https://www.pokemon.com/us/pokemon-tcg/rules">official rulebook</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="the-technology"><a class="header" href="#the-technology">The technology</a></h1>
<p>Pok√©-Fun is implemented using <a href="https://kotlinlang.org/">Kotlin</a>, <a href="https://arrow-kt.io/">Arrow</a>, and <a href="https://www.jetbrains.com/lp/compose-multiplatform/">Compose Multiplatform</a>. The latter has been chosen because it provides the same concepts to build user interfaces in a variety of platforms. In particular, we can write a desktop application that runs easily everywhere (the perks of using the JVM üòâ).</p>
<p>The one choice which goes out of the ordinary is using <a href="https://github.com/JetBrains/amper">Amper</a> as build tool, instead of Gradle, much better-known among Kotliners. Feel free to look at the <code>module.yaml</code> file, but for the tasks you won't need to touch it. To start the application you can run <code>./amper run</code> in a command line. The first time it may take some time to start, since build tools, compiler, and dependencies need to be set up.</p>
<p>We recommend using <a href="https://www.jetbrains.com/idea/">IntelliJ IDEA</a> or <a href="https://developer.android.com/studio">Android Studio</a> to work on Pok√©-Fun. You need at least the corresponding <a href="https://plugins.jetbrains.com/plugin/23076-amper">Amper plug-in</a>, and the <a href="https://plugins.jetbrains.com/plugin/14936-kotlin-multiplatform">Kotlin Multiplatform plug-in</a> is highly recommended. In both cases, you should see a small play button to run the application from the IDE.</p>
<h2 id="compose-multiplatform"><a class="header" href="#compose-multiplatform">Compose Multiplatform</a></h2>
<p>In the recent years we have seen an explosion of a new paradigm for UI development, based on managing the state separately from the view, which is then defined as a function which is re-executed everytime the state changes. Some well-known frameworks include <a href="https://react.dev/">React</a> for web, <a href="https://developer.apple.com/xcode/swiftui/">SwiftUI</a> for iOS, and <a href="https://developer.android.com/develop/ui/compose">Jetpack Compose</a> for Android. <a href="https://www.jetbrains.com/lp/compose-multiplatform/">Compose Multiplatform</a> uses the same concepts of the latter, but targeting several platforms (at the time of writing: desktop, Android, iOS, and web via WebAssembly).</p>
<div id="admonition-more-about-compose-multiplatform" class="admonition admonish-info" role="note" aria-labelledby="admonition-more-about-compose-multiplatform-title">
<div class="admonition-title">
<div id="admonition-more-about-compose-multiplatform-title">
<p>More about Compose Multiplatform</p>
</div>
<a class="admonition-anchor-link" href="tech-intro.html#admonition-more-about-compose-multiplatform"></a>
</div>
<div>
<p>There is still not much documentation about Compose Multiplatform, but most of the information about Jetpack Compose (for Android) applies only with minor modifications.</p>
<ul>
<li><a href="https://developer.android.com/courses/android-basics-compose/course">Android Basics with Compose</a>,</li>
<li><a href="https://developer.android.com/develop/ui/compose/documentation">Jetpack Compose guides</a> from Google,</li>
<li><a href="https://www.jetbrains.com/help/kotlin-multiplatform-dev/compose-multiplatform-getting-started.html">Create a Compose Multiplarform app</a>,</li>
<li><a href="https://www.youtube.com/@PhilippLackner/videos">Philipp Lackner</a> has videos covering Compose Multiplarform.</li>
</ul>
</div>
</div>
<p>Compose applications are typically built from two components:</p>
<ul>
<li><em>View models</em> keep (part of) the state of the application, and communicate with the outside world.</li>
<li><em>Views</em> define how this state is mapped into a set of UI elements laid out in the screen. Views are defined as functions with the <code>@Composable</code> annotation, which is required for the framework to be able to run them whenever the state (or part of it) changes.</li>
</ul>
<p>Let us look at the simplest application: a button which counts how many times it has been pressed. The state is basically a counter. To define the read-only version we use <a href="https://kotlinlang.org/docs/delegated-properties.html">property delegation</a>.</p>
<pre><code class="language-kotlin">class Counter: ViewModel() {
  // 1. define a state, starting with 0
  private val _count = mutableStateOf(0)

  // 2. expose the state in a read-only manner
  val count: Int by _count

  // 3. operations to change the state
  fun increment() {
    _count.value++
  }
}
</code></pre>
<p>The view consumes this view model, and shows a button with a text indicating the amount of times it has been clicked.</p>
<pre><code class="language-kotlin">@Composable fun Screen(counter: Counter) {
  Button(onClick = { counter.increment() }) {
    Text("Clicked ${counter.count} times")
  }
}
</code></pre>
<p>What happens when the button is pressed? Then the <code>onClick</code> lambda is executed, which eventually changes the value of <code>_count</code>. Compose detects this change and <em>recomposes</em> the UI, that is, re-executes <code>Screen</code> and applies any update to the visible screen. As discussed above, the <code>@Composable</code> annotation (alongside the Compose compiler) is the magic that makes this link work.</p>
<p>Armed with this knowledge, you can read the <a href="./intro.html">introduction</a> to Pok√©-Fun.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="overview-of-the-code"><a class="header" href="#overview-of-the-code">Overview of the code</a></h1>
<p>Now that you know about the <a href="./tcg.html">domain</a> and the <a href="./tech-intro.html">technology</a>, we can describe the given implementation of Pok√©-Fun.</p>
<h2 id="cards"><a class="header" href="#cards">Cards</a></h2>
<p>The <code>tcg</code> module gives access to cards and their information.</p>
<ul>
<li>The <code>tcg.kt</code> file defines a set of types that represent the information in cards, including their name, identifier, category, and type. We shall delve on these types in the <a href="./adt.html"><em>What is (in) a deck</em></a> section.</li>
<li>Basic validation is implemented in <code>validation.kt</code>. In the <a href="./validation.html"><em>Validation</em></a> section we'll improve this functionality.</li>
</ul>
<h2 id="general-design"><a class="header" href="#general-design">General design</a></h2>
<p>The diagram below roughly represents how Pok√©-Fun is architected.</p>
<pre class="mermaid">graph LR;
  PokemonTcgApi;
  SearchViewModel;
  PokemonTcgApi &lt;-.- SearchViewModel;
  DeckViewModel;
  subgraph View [SplitPane]
    SearchPane;
    DeckPane;
  end
  SearchViewModel --- SearchPane;
  DeckViewModel --- SearchPane;
  DeckViewModel --- DeckPane;
</pre>
<p>In the center we find two different view models, which serve different purposes:</p>
<ul>
<li><code>DeckViewModel</code> (in <code>deck/viewModel.kt</code>) keeps track of the current status of the deck, including the cards contained in it, and the (potential) problems with that choice of cards.</li>
<li><code>SearchViewModel</code> (in <code>search/viewModel.kt</code>) keeps track of the state of search, and is responsible for communicating with the <a href="https://docs.pokemontcg.io/">Pok√©mon TCG API</a>.</li>
</ul>
<p>Access to the Pok√©mon TCG API is mediated by the <code>PokemonTcgApi</code> interface (in the <code>tcg/api</code> folder), for which we give a "real" implementation talking over the network using Ktor's <a href="https://ktor.io/docs/client-create-new-application.html">client module</a>, and a "fake" one with a few predefined cards. After finishing the <a href="./resilience.html"><em>Deal with bad internet</em></a> section, we'll have some respectable code.</p>
<p>Two different views represent the data of the view models in a graphical manner. Those are put together in a single screen using a <code>SplitPane</code>, one of the <a href="https://github.com/JetBrains/compose-multiplatform/blob/master/tutorials/README.md#desktop">desktop-specific components</a> offered by Compose Multiplatform.</p>
<ul>
<li>On the left-hand side we have the <code>SearchPane</code> (in <code>search/view.kt</code>), where the users input their search and see results. This view also adds selected cards to the deck, hence the dependence on the <code>DeckViewModel</code>.</li>
<li>On the right-hand side we have the <code>DeckPane</code> (in <code>deck/view.kt</code>), which simply shows the cards and problems.</li>
</ul>
<p>Both view make use of common component to show a single <code>Card</code> and multiple <code>Card</code>s, found in <code>tcg/cardView.kt</code>. These components have an <code>extra</code> parameter which is used to provide the different elements required in each of the views (for example, the <em>Add</em> button in the search pane).</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="what-is-a-deck"><a class="header" href="#what-is-a-deck">What is a deck</a></h1>
<blockquote>
<p><strong>Topics</strong>: sealed hierachies, data classes, immutability</p>
</blockquote>
<p>One of the key components in the <em>functional</em> approach to programming we promote is how we <strong>model</strong> the data. In other words, how we represent the information we care about throughout the execution of our application.</p>
<p>We prefer a <strong>immutable</strong> representation to one where mutation is available. This main benefit is at the level of <em>reasoning</em>, as it becomes much easier to understand what is going on and potential problems. If instead of modifying data we always transform it into a completely new value, we do not need to care about concurrent accesses. More bluntly, a whole source of potential bugs disappear when using immutability.</p>
<p>This property alone has a profound impact on our data types. Since there is no mutation, the values are <strong>stateless</strong>. Instead of thinking about modification, for example with <code>person.setName("me")</code>, we think in terms of transformation and copying, <code>person.copy(name = "me")</code>. Functional programmers are usually proud of their <strong>anemic</strong> domain models, in which operations always exist as transformations of data.</p>
<p>We also strive for a <strong>precise</strong> representation, which captures every possible <em>invariant</em> (domain rule) in our data. A prime example from the UI world is data which may also be loading or have errors while obtaining. One potential representation is given by</p>
<pre><code class="language-kotlin">class Result(
  val data: Card?,
  val problem: Throwable?
)
</code></pre>
<p>with the additional invariant that at most one of the values should be non-<code>null</code>, and both being <code>null</code> represents a loading state.</p>
<p>This is problematic, though, because there is nothing stopping us from breaking that invariant. A more precise representation capture the three possible states as three different types in a sealed hierarchy,</p>
<pre><code class="language-kotlin">sealed interface Result {
  data object Loading: Result
  data class Success(val data: Card): Result
  data class Problem(val problem: Throwable): Result
}
</code></pre>
<p>Now the compiler guarantees that the right information is present at each point. Furthermore, we gain the ability to use <code>when</code> to check the current state, and the compiler guarantees that we always handle all possible cases.</p>
<div id="admonition-sealed-hierarchies-are-everywhere" class="admonition admonish-tip" role="note" aria-labelledby="admonition-sealed-hierarchies-are-everywhere-title">
<div class="admonition-title">
<div id="admonition-sealed-hierarchies-are-everywhere-title">
<p>Sealed hierarchies are everywhere</p>
</div>
<a class="admonition-anchor-link" href="adt.html#admonition-sealed-hierarchies-are-everywhere"></a>
</div>
<div>
<p>The <code>SearchStatus</code> type used in <code>search/viewModel.kt</code> is quite similar to <code>Result</code> above. You can take a look at that file and the corresponding view to see how one operates with sealed hierarchies.</p>
</div>
</div>
<p>One nice advantage of using Compose is that it naturally leads to a more immutable representation of state. In the following tasks we focus on the precision of our domain model.</p>
<div id="admonition-more-on-functional-domain-modeling" class="admonition admonish-info" role="note" aria-labelledby="admonition-more-on-functional-domain-modeling-title">
<div class="admonition-title">
<div id="admonition-more-on-functional-domain-modeling-title">
<p>More on functional domain modeling</p>
</div>
<a class="admonition-anchor-link" href="adt.html#admonition-more-on-functional-domain-modeling"></a>
</div>
<div>
<ul>
<li><a href="https://arrow-kt.io/learn/design/domain-modeling/">Domain modeling</a> in Arrow documentation.</li>
<li>The book <a href="https://pragprog.com/titles/swdddf/domain-modeling-made-functional/">Domain modeling made functional</a> by Scott Wlaschin introduces many of these ideas in the context of F#, but it maps quite well to Kotlin.</li>
</ul>
</div>
</div>
<h2 id="more-precise-type"><a class="header" href="#more-precise-type">More precise <code>type</code></a></h2>
<p>The given domain model uses a nullable <code>Type</code> in <code>Card</code>. This is because not every card in the Pok√©mon TCG has a type; this attribute is restricted to Pok√©mon and <em>basic</em> Energy cards. Your <strong>task</strong> is to transform the given domain model to capture that invariant.</p>
<h2 id="more-precise-energies"><a class="header" href="#more-precise-energies">More precise energies</a></h2>
<p>Even the previous refinement is not completely true. In fact, two types have some special meaning in the game:</p>
<ul>
<li><em>Dragon</em> may be the type of a Pok√©mon, but never the type of an Energy. In the game, this manifests as attacks never requiring "dragon energy"; dragon Pok√©mon always use a combination of other energies.</li>
<li>When <em>colorless</em> energy appears in a cost, it may be paid by <em>any</em> type of energy. There are no basic Colorless Energy card, but there are Colorless Pok√©mon.</li>
</ul>
<div class="table-wrapper"><table><thead><tr><th></th><th></th><th></th></tr></thead><tbody>
<tr><td><img src="https://images.pokemontcg.io/svp/91_hires.png" alt="Koraidon" /></td><td><img src="https://images.pokemontcg.io/svp/92_hires.png" alt="Miraidon" /></td><td>These cards are of <em>dragon</em> <img src="images/dragon.png" height="15px" /> type, but their attacks do not use that energy (since it's forbidden). However, they both use <em>colorless</em> <img src="images/colorless.png" height="15px" /> energy.</td></tr>
<tr><td><img src="https://images.pokemontcg.io/sv5/181_hires.png" alt="Chatot" /></td><td><img src="https://images.pokemontcg.io/svp/51_hires.png" alt="Snorlax" /></td><td>These cards are of <em>colorless</em> type. They are used in every type of deck, since their attack cost can be paid using any energy.</td></tr>
</tbody></table>
</div>
<p>Your <strong>task</strong> is to refine the given <em>Type</em> to account for these nuances. However, your solution should <em>not</em> be just two or more different types; by using inheritance you can create several subsets of types and share common cases.</p>
<h2 id="information-about-evolution"><a class="header" href="#information-about-evolution">Information about evolution</a></h2>
<p>One of the most important features of the Pok√©mon franchise is that Pok√©mon <em>evolve</em>, that is, they turn into (stronger) Pok√©mon as they progress. This is mapped in the TCG as Stage 1 and Stage 2 Pok√©mon describing which Pok√©mon they evolve from.</p>
<div id="admonition-one-direction-does-not-imply-the-other" class="admonition admonish-bug" role="note" aria-labelledby="admonition-one-direction-does-not-imply-the-other-title">
<div class="admonition-title">
<div id="admonition-one-direction-does-not-imply-the-other-title">
<p>One direction does not imply the other</p>
</div>
<a class="admonition-anchor-link" href="adt.html#admonition-one-direction-does-not-imply-the-other"></a>
</div>
<div>
<p>Every Stage 1 or Stage 2 Pok√©mon evolves <em>from exactly one</em> Pok√©mon. However, the converse is not true: a single Pok√©mon may evolve <em>to more than one</em> Pok√©mon (or none). For example, Gloom may evolve into Vileplume and Bellossom, with Eevee having record eight different evolutions.</p>
</div>
</div>
<div class="table-wrapper"><table><thead><tr><th></th><th></th><th></th><th></th></tr></thead><tbody>
<tr><td><img src="https://images.pokemontcg.io/sv3pt5/43_hires.png" alt="Oddish" /></td><td><img src="https://images.pokemontcg.io/sv3pt5/44_hires.png" alt="Gloom" /></td><td><img src="https://images.pokemontcg.io/sv3pt5/45_hires.png" alt="Vileplume" /></td><td><img src="https://images.pokemontcg.io/sv3/3_hires.png" alt="Bellossom" /></td></tr>
</tbody></table>
</div>
<p>Your <strong>task</strong> is to refine the domain model to include this information. You need to also update the <code>KtorPokemonTcgApi</code> implementation to account for this extra attribute, check the <a href="https://docs.pokemontcg.io/">Pok√©mon TCG API docs</a> for the place where it appears.</p>
<div id="admonition-kotlinxserialization" class="admonition admonish-info" role="note" aria-labelledby="admonition-kotlinxserialization-title">
<div class="admonition-title">
<div id="admonition-kotlinxserialization-title">
<p>kotlinx.serialization</p>
</div>
<a class="admonition-anchor-link" href="adt.html#admonition-kotlinxserialization"></a>
</div>
<div>
<p>The code uses <code>kotlinx.serialization</code> to transform the JSON returned by the API into Kotlin data classes. For more information, check the <a href="https://kotlinlang.org/docs/serialization.html#serialize-and-deserialize-json">introduction</a> and the <a href="https://github.com/Kotlin/kotlinx.serialization/blob/master/docs/basic-serialization.md">basic guide</a>.</p>
</div>
</div>
<p>As an <strong>additional task</strong>, you can improve the ordering of the deck shown in the right pane by taking evolution into account: evolution chains should appear together.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="law-abiding-decks"><a class="header" href="#law-abiding-decks">Law-abiding decks</a></h1>
<blockquote>
<p><strong>Topics</strong>: validation, <code>Raise</code>, error accumulation</p>
</blockquote>
<p>Handling errors is one of the scenarios where a functional approach shines. Using types like <code>Either</code> and contexts like <code>Raise</code>, we can easily compose larger validations from smaller ones.</p>
<p>This topic is well documented in the official Arrow documentation, we suggest the reader to check the following material:</p>
<ul>
<li><a href="https://arrow-kt.io/learn/typed-errors/working-with-typed-errors/">Working with typed errors</a></li>
<li><a href="https://arrow-kt.io/learn/typed-errors/validation/">Validation</a></li>
</ul>
<p>Feel free to use any style that you prefer in this section. When in doubt, using <code>Raise</code> (as opposed to <code>Either</code>) is the preferred option when using Arrow.</p>
<h2 id="legal-decks"><a class="header" href="#legal-decks">Legal decks</a></h2>
<p>Your <strong>task</strong> in this section is to implement the rules for a <em>legal</em> deck, that is, one that can be used to play Pok√©mon TCG. The <code>tcg/validation.kt</code> file contains a barebones implementation of <code>validate</code>, which simply checks the number of cards in the deck, and a non-empty title.</p>
<p>The main rules for the legality of a deck are:</p>
<ul>
<li>The deck must contain exactly 60 cards,</li>
<li>There must be at most 4 cards with the same name,
<ul>
<li>Note that cards with different identifiers but the same name are added together,</li>
<li>The only exception to this rule are <em>basic</em> Energy cards, of which you can have an unlimited amount,</li>
</ul>
</li>
<li>There must be at least one <em>basic</em> Pok√©mon.</li>
</ul>
<p>Implement this validation using <code>Either</code> or <code>Raise</code>, and try to break the process in different functions. The notion of <a href="https://arrow-kt.io/learn/typed-errors/validation/#fail-first-vs-accumulation">fail-first vs. accumulation</a> is important here, so you can squeeze as much information as possible.</p>
<p><strong>Extra task</strong>: implement a rule to check that you can always <em>evolve</em> every Pok√©mon in your deck. This means you if you have a Stage 1 or Stage 2 Pok√©mon, you should have a card for the Pok√©mon it evolves from.</p>
<h2 id="problems-tied-to-specific-cards"><a class="header" href="#problems-tied-to-specific-cards">Problems tied to specific cards</a></h2>
<p>This first task simply gives back a list of string for each problem, but this approach goes against our aim of precise types. Your <strong>task</strong> here is introduce an <em>error hierarchy</em> that represents each possible problem with the deck. The transformation to string should now happen in the <code>DeckPane</code> view instead.</p>
<p><strong>Extra task</strong>: show problems related to specific cards directly on them. For example, by showing the name in the <code>MaterialTheme.colorScheme.error</code> color. Think about how the information required in the error hierarchy.</p>
<h2 id="reactive-problems"><a class="header" href="#reactive-problems">Reactive problems</a></h2>
<p>The current implementation has a potential problem: you need to update <code>_problems</code> every time you update <code>_deck</code>. But actually, the problems of a deck directly derive from the contents of the deck itself. Reactive frameworks like <a href="https://github.com/ReactiveX/RxJava">RxJava</a> allow expressing this connection directly, and we can easily do the same using <code>MutableState</code>.</p>
<p>Your <strong>task</strong> is to replace each update to the <code>_problems</code> mutable state with a new definition based on <code>_deck</code>. You can use the function <code>map</code> in <code>utils/mutableState.kt</code>.</p>
<div id="admonition-map-as-in-lists" class="admonition admonish-info" role="note" aria-labelledby="admonition-map-as-in-lists-title">
<div class="admonition-title">
<div id="admonition-map-as-in-lists-title">
<p>Map as in lists</p>
</div>
<a class="admonition-anchor-link" href="validation.html#admonition-map-as-in-lists"></a>
</div>
<div>
<p>An intuitive understanding for this operation arises if we look at a <code>MutableState</code> as a <em>list</em> of all the values as the time flows. In that way, the problems arise as <code>map</code>ping the validation over each element of that list.</p>
</div>
</div>
<h2 id="gym-leader-challenge"><a class="header" href="#gym-leader-challenge">Gym Leader Challenge</a></h2>
<p>The rules described above correspond to the <em>Standard</em> format, which is the one sanctioned for tournaments. However, fans of the game have come with other formats, like <a href="https://gymleaderchallenge.com/">Gym Leader Challenge</a> (GLC). As an <strong>extra task</strong>, you may implement <a href="https://gymleaderchallenge.com/rules">GLC rules</a>.</p>
<ul>
<li>You may need to add some UI element to specify the format your deck is in.</li>
<li>GLC forbids some sorts of cards, namely those with a Rule Box and ACE SPECs. This information is available from the API, but currently not reflected in the domain model.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="deck-building"><a class="header" href="#deck-building">Deck building</a></h1>
<blockquote>
<p><strong>Topics</strong>: reducers, actions as data</p>
</blockquote>
<p>This section dives a bit more in how we can see a view model from the lenses of an important topic in functional programming: <em>reducers</em> (also known as <em>folds</em>, or if you prefer a Greeker word, <em>catamorphisms</em>).</p>
<p>Let's look at the components of the <code>DeckViewModel</code>:</p>
<ul>
<li>An <em>initial</em> state, comprised of <code>Awesome Deck</code> as title and an empty list of cards,</li>
<li>A series of <em>operations</em> (<code>changeTitle</code>, <code>clear</code>, <code>add</code>) which transform this state.</li>
</ul>
<p>Using these two elements, we can understand the whole lifetime of the application as consecutive steps, each transforming the previous state.</p>
<pre class="mermaid">graph LR;
  State1[State 1];
  State2[State 2];
  State3[State 3];
  State4[...];
  Initial --&gt;|add| State1;
  State1 --&gt;|changeTitle| State2;
  State2 --&gt;|add| State3;
  State3 --&gt;|add| State4;
</pre>
<p>To understand why we call this the <em>reducer</em> model, let's take a small leap of faith, and assume we somehow represent the sequence of transformations as a list (no worries, we are making this real in a few paragraphs). Then the <em>current</em> state of the system is define using the <code>fold</code> operation over the list of transformations until that point.</p>
<pre><code class="language-kotlin">val currentState =
  transformationsUntilNow.fold(initialState) { state, transformation -&gt;
    transformation.apply(state)
  }
</code></pre>
<div id="admonition-fold-and-reduce" class="admonition admonish-abstract" role="note" aria-labelledby="admonition-fold-and-reduce-title">
<div class="admonition-title">
<div id="admonition-fold-and-reduce-title">
<p>Fold and reduce</p>
</div>
<a class="admonition-anchor-link" href="build.html#admonition-fold-and-reduce"></a>
</div>
<div>
<p>In Kotlin, the difference between <code>fold</code> and <code>reduce</code> is that in the former you provide an initial state, whereas in the latter the initial state is the first element in the list. But this is not as clear cut in other programming languages. For example, <a href="https://redux.js.org/">Redux</a> is one of the libraries that popularized this concept in JavaScript.</p>
</div>
</div>
<p>Instead of using methods, we can express each of the available operations as data. We call this technique <em>actions as data</em>, or with a fancier term, <em>reification</em>. The description of each action should contain enough information to apply the operation to the current state. For our view model, we obtain:</p>
<pre><code class="language-kotlin">sealed interface DeckOperation {
  data class ChangeTitle(val newTitle: String): DeckOperation
  data class AddCard(val card: Card): DeckOperation
  data object Clear: DeckOperation
}
</code></pre>
<p>Now our view model can use a single function, and dispatch based on the operation.</p>
<pre><code class="language-kotlin">class DeckViewModel: ViewModel() {
  fun apply(operation: DeckOperation) = when (operation) {
    is DeckOperation.ChangeTitle -&gt; { ... }
    is DeckOperation.AddCard -&gt; { ... }
    DeckOperation.Clear -&gt; { ... }
  }
}
</code></pre>
<p>In the tasks below we use this idea to improve the implementation, and introduce new functionality.</p>
<div id="admonition-initial-style-dsls" class="admonition admonish-info" role="note" aria-labelledby="admonition-initial-style-dsls-title">
<div class="admonition-title">
<div id="admonition-initial-style-dsls-title">
<p>Initial style DSLs</p>
</div>
<a class="admonition-anchor-link" href="build.html#admonition-initial-style-dsls"></a>
</div>
<div>
<p>Actions as data is the beginning of a journey to <em>domain specific languages</em> (DSLs), the idea of introducing a small language to describe your specific domain. In particular, actions as data relate to a particular technique to implement DSLs, called <em>initial style</em>. <a href="https://serranofp.com/inikio/">Inikio</a> is a compiler plug-in to facilitate the development of such DSLs in Kotlin.</p>
</div>
</div>
<h2 id="move-to-actions-as-data"><a class="header" href="#move-to-actions-as-data">Move to actions as data</a></h2>
<p>Your <strong>task</strong> is to finish the conversion of the given code into an actions-as-data-based approach. That is, copy (and extend if necessary) the <code>DeckOperation</code> type given above, and change the view model to use a single point of entry <code>apply</code> to every transformation.</p>
<div id="admonition-keeping-the-current-state" class="admonition admonish-warning" role="note" aria-labelledby="admonition-keeping-the-current-state-title">
<div class="admonition-title">
<div id="admonition-keeping-the-current-state-title">
<p>Keeping the current state</p>
</div>
<a class="admonition-anchor-link" href="build.html#admonition-keeping-the-current-state"></a>
</div>
<div>
<p>Even though you can keep just the list of actions that were performed, and apply them whenever the current state is required, this choice usually leads to bad performance. We strongly recommend that you keep the same <code>MutableState</code> as you have now.</p>
</div>
</div>
<h2 id="remove-a-card"><a class="header" href="#remove-a-card">Remove a card</a></h2>
<p>Right now the only option the users of Pok√©-Fun have if they have added a card they do not like is to clear the entire deck ü´† Your <strong>task</strong> is to implement functionality to <em>remove</em> a card from the deck: this involes changes in <em>both</em> view model and view.</p>
<div id="admonition-tip" class="admonition admonish-tip" role="note" aria-labelledby="admonition-tip-title">
<div class="admonition-title">
<div id="admonition-tip-title">
<p>Tip</p>
</div>
<a class="admonition-anchor-link" href="build.html#admonition-tip"></a>
</div>
<div>
<p>Take a look at <code>search/view.kt</code> to see how to add components to each card shown on the screen.</p>
</div>
</div>
<h2 id="undo-and-redo"><a class="header" href="#undo-and-redo">Undo and redo</a></h2>
<p>One functionality which becomes much easier to implement when operations are reified as data is undo and redo, since you can very easily keep track of what the user has done.</p>
<p>Your <strong>task</strong> is to finish the implementation: the given view contains buttons for the actions, but they do nothing and are never enabled. At the end, the corresponding buttons in the view should only be enabled when there are operations to undo (or redo, respectively).</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="deal-with-bad-internet"><a class="header" href="#deal-with-bad-internet">Deal with bad internet</a></h1>
<blockquote>
<p><strong>Topics</strong>: resilience, <code>Schedule</code>, circuit breaker, caching</p>
</blockquote>
<p>The given implementation of Pok√©-Fun works fine... if the internet connection is fine (extra points for irony if the room where you are working on this tasks has bad internet). Any realistic application that accesses other services must protect itself against potential disconnections, lags, or services which are down. We refer with the term <em>resilience</em> to all those techniques which help in providing a better experience in problematic scenarios.</p>
<p>This topic is well documented in the official Arrow documentation, we suggest the reader to check the <a href="https://arrow-kt.io/learn/resilience/intro/">Resilience section</a>, both the introduction and the pages describing <a href="https://arrow-kt.io/learn/resilience/retry-and-repeat/"><code>Schedule</code></a> and <a href="https://arrow-kt.io/learn/resilience/circuitbreaker/"><code>CircuitBreaker</code></a>.</p>
<div id="admonition-decorator" class="admonition admonish-tip" role="note" aria-labelledby="admonition-decorator-title">
<div class="admonition-title">
<div id="admonition-decorator-title">
<p>Decorator</p>
</div>
<a class="admonition-anchor-link" href="resilience.html#admonition-decorator"></a>
</div>
<div>
<p>We strongly recommend to use the <a href="https://refactoring.guru/design-patterns/decorator">Decorator pattern</a> in the following tasks. For a good introduction, fully in Kotlin, check <a href="https://www.youtube.com/watch?v=erWsXSqQ-CM">this video</a> by Dave Leeds.</p>
</div>
</div>
<h2 id="retry-if-fails"><a class="header" href="#retry-if-fails">Retry if fails</a></h2>
<p>The task here is to create a wrapper that adds retry capabilities to an inner <code>PokemonTcgApi</code> instance. Explore different variations of the <a href="https://arrow-kt.io/learn/resilience/retry-and-repeat/#constructing-a-policy"><code>Schedule</code></a>, from a simple fixed repetition, to exponential backoff policies.</p>
<h3 id="use-a-circuit-breaker"><a class="header" href="#use-a-circuit-breaker">Use a circuit breaker</a></h3>
<p>Improve the previous soltuion with a <a href="https://arrow-kt.io/learn/resilience/circuitbreaker/">circuit breaker</a>, which ensures that we do not overload the service or the client in case the (transient) failure takes a long time to recover.</p>
<p>As described in the <a href="https://arrow-kt.io/learn/resilience/circuitbreaker/">documentation</a>, the best option for resilience is to combine both approaches.</p>
<blockquote>
<p>A common pattern to make resilient systems is to compose a circuit breaker with a backing-off policy that prevents the resource from overloading. <code>Schedule</code> is insufficient to make your system resilient because you also have to consider parallel calls to your functions. In contrast, a circuit breaker track failures of every function call or even different functions to the same resource or service.</p>
</blockquote>
<h2 id="introduce-a-cache"><a class="header" href="#introduce-a-cache">Introduce a cache</a></h2>
<p>The given implementation queries the Pok√©mon TCG API service for <em>every</em> search and every card. However, cards with an existing identifier almost never change (except for errata), so there is no need to get them over and over. Searches also change rarely: new sets with additional cards only appear every 3 months, and we do not expect our users to stay that long in the application.</p>
<p>Introducing a <em>cache</em> improves performance, and also makes our application more resilient, since fewer calls need to communicate outside. Your <strong>task</strong> is to introduce <a href="https://reactivecircus.github.io/cache4k/">Cache4k</a>, a nice Kotlin Multiplatform option for this matter.</p>
<div id="admonition-caching-and-memoization" class="admonition admonish-info" role="note" aria-labelledby="admonition-caching-and-memoization-title">
<div class="admonition-title">
<div id="admonition-caching-and-memoization-title">
<p>Caching and memoization</p>
</div>
<a class="admonition-anchor-link" href="resilience.html#admonition-caching-and-memoization"></a>
</div>
<div>
<p><em>Memoization</em> is a concept in functional programming very related to caching. If you have a completely <em>pure</em> function ‚Äî no other effect except computation ‚Äî then every run with the same input argument should give you the same output. As a result, there is no need to run the function twice. This becomes especially relevant for recursive functions like Fibonacci. Arrow comes with <a href="https://arrow-kt.io/learn/collections-functions/recursive/#memoized-recursive-functions"><code>MemoizedDeepRecursiveFunction</code></a>, which improved over the usual deep recursion support in Kotlin.</p>
<p>The task at hand, however, is not really in the realm of memoization. First of all, we do not have a pure computation, but rather data coming from external sources. In addition, recursion is completely absent from API calls.</p>
</div>
</div><div style="break-before: page; page-break-before: always;"></div><h1 id="loading-and-saving"><a class="header" href="#loading-and-saving">Loading and saving</a></h1>
<blockquote>
<p><strong>Topics</strong>: parallel operations, <code>Raise</code> + exceptions + concurrency</p>
</blockquote>
<p>Pok√©-Fun as provided has a very big limitation. You can only work on your deck in one go: if you want to devote several sessions to it, you must either (1) not close the application, or (2) write down your cards in a piece of paper and add them back the next time. In this section we add support for loading and saving <em>deck files</em>, and learn about high-level parallelism on the way.</p>
<h2 id="load-and-store"><a class="header" href="#load-and-store">Load and store</a></h2>
<p>The first <strong>task</strong> is to implement saving the deck as a file, and being able to read it back afterward. Feel free to choose whatever format you like, from the list of identifiers separated by new lines, to some sort of JSON.</p>
<p>The code provided in <code>deck/view.kt</code> integrates <a href="https://github.com/vinceglb/FileKit">FileKit</a> to show the file picker of the platform the application is running on. The button are disabled, remember to set <code>enabled = true</code> in the call to <code>IconButton</code>.</p>
<p>Saving the deck is easy, but loading it potentially involves getting the information from each of them. You should use the <code>getById</code> method from <code>PokemonTcgApi</code> to retrieve the <code>Card</code> corresponding to a given identifier.</p>
<p>In a first approximation, using <code>map</code> over the sequence of identifiers should be enough. Albeit simple, that solution lacks performance. Arrow provides <a href="https://arrow-kt.io/learn/coroutines/parallel/"><em>high-level concurrency</em></a> which solves the problem quite succintly. Use <a href="https://arrow-kt.io/learn/coroutines/parallel/#independently-in-parallel"><code>parMap</code></a> to turn the sequential iteration into a concurrent set of operations.</p>
<p>Another problem with the simple approach, depending on how you store the data from a deck, is that you may ask information about the same card more than once. One potential solution is to group the cards by identifier, but a more general approach is to use <a href="./resilience.html#introduce-a-cache">caching</a> that works independently of the number of consumers.</p>
<h2 id="from-exceptions-to-raise"><a class="header" href="#from-exceptions-to-raise">From exceptions to <code>Raise</code></a></h2>
<p>Problems may arise during the retrieval of card information, but the current code is not prepared for that eventuality. In this section we improve the situation by using <code>Raise</code>.</p>
<div id="admonition-about-raise" class="admonition admonish-info" role="note" aria-labelledby="admonition-about-raise-title">
<div class="admonition-title">
<div id="admonition-about-raise-title">
<p>About Raise</p>
</div>
<a class="admonition-anchor-link" href="par.html#admonition-about-raise"></a>
</div>
<div>
<p>It is strongly recommended to read the <a href="./validation.html"><em>Law-abiding decks</em></a> section, which introduces the basics of <code>Raise</code>, before attempting the following task.</p>
<p>The integration of <code>parMap</code> (and <code>parZip</code>) with <code>Raise</code> and error accumulation is discussed in the <a href="https://arrow-kt.io/learn/coroutines/parallel/#integration-with-typed-errors">Arrow documentation</a>. Although the TL;DR is simply "replace <code>mapOrAccumulate</code> with <code>parMapOrAccumulate</code> and enjoy".</p>
</div>
</div>
<p>Your <strong>task</strong> is to use <a href="https://arrow-kt.io/learn/typed-errors/working-with-typed-errors/#from-exceptions"><code>Either.catch</code></a> to capture any potential exceptions, and transform then into <code>Either</code>. As hinted in the <a href="./validation.html"><em>Law-abiding decks</em></a> section, you need to define an error hierarchy to represent those problems.</p>
<div id="admonition-several-error-hierarchies" class="admonition admonish-tip" role="note" aria-labelledby="admonition-several-error-hierarchies-title">
<div class="admonition-title">
<div id="admonition-several-error-hierarchies-title">
<p>Several error hierarchies</p>
</div>
<a class="admonition-anchor-link" href="par.html#admonition-several-error-hierarchies"></a>
</div>
<div>
<p>It is <em>not</em> necessary to have a single error hierarchy for the entire domain. You only need a common parent whenever you may be mixing those in a single function, which means your error hierarchy is actually shared by two parts of the domain.</p>
</div>
</div>
<p>By default, using the <code>either</code> builder means following a fail-first approach to errors. If you have not done it directly on the previous task, change the behavior to <em>accumulation</em>. In other words, you should report every problem you find loading a file, not only the first identifier you fail to obtain.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="better-architecture"><a class="header" href="#better-architecture">Better architecture</a></h1>
<blockquote>
<p><strong>Topics</strong>: resource management, <code>SuspendApp</code></p>
</blockquote>
<p>Not all the work you do in an application directly translates into new features. Ensuring that the code remains understandable at the macro and micro level is an important task of a good developer.</p>
<div id="admonition-scouts-rule" class="admonition admonish-quote" role="note" aria-labelledby="admonition-scouts-rule-title">
<div class="admonition-title">
<div id="admonition-scouts-rule-title">
<p>Scouts rule</p>
</div>
<a class="admonition-anchor-link" href="architecture.html#admonition-scouts-rule"></a>
</div>
<div>
<p><em>Leave something slightly better of than you found it.</em></p>
</div>
</div>
<h2 id="as-explicit-as-possible"><a class="header" href="#as-explicit-as-possible">As explicit as possible</a></h2>
<p>One of the mottos of the style of functional programming we promote is making explicit as much of the function behavior as possible. In statically-typed languages like Kotlin, <em>explicit</em> means <em>in the function signature</em>. The information we want to explicit in functions are, among others:</p>
<ol>
<li>Services and resources required to execute the function. Those may be provided as simple arguments, or using <em>extension receivers</em> (and in the future, with <a href="https://github.com/Kotlin/KEEP/blob/context-parameters/proposals/context-parameters.md"><em>context parameters</em></a>).</li>
<li>Whether the function is pure (in other words, it is just computation) or may perform side effects. In the latter case, we mark the function with <code>suspend</code>.</li>
</ol>
<p>A longer explanation, including more examples of the usage of receivers, can be found in the <a href="https://arrow-kt.io/learn/design/effects-contexts/">Arrow documentation</a>.</p>
<p>One downside which is often mentioned of that style is that dependencies need to be <em>manually</em> injected. That is, the developer creates the instances of every service used by the application, as opposed to using a dependency injection (DI) framework like <a href="https://insert-koin.io/">Koin</a> and <a href="https://developer.android.com/training/dependency-injection/hilt-android">Hilt</a>. However, we don't see this as a downside: by taking control of the creation of services we end up with simpler logic, minimize the amount of inter-dependencies, and avoid runtime or compile-time costs associated to DI frameworks.</p>
<h2 id="resource-management"><a class="header" href="#resource-management">Resource management</a></h2>
<p>One of the challenges with this style of programming is managing the acquisition and release of resources and services. One of the problems is too much <em>nesting</em> in their creation,</p>
<pre><code class="language-kotlin">HttpClient().use { client -&gt;
  KtorPokemonTcgApi(client).use { api -&gt;
    // now start the application
  }
}
</code></pre>
<p>Arrow solves this problem with <a href="https://arrow-kt.io/learn/coroutines/resource-safety/"><code>resourceScope</code> blocks</a>. The code above can be rewritten with any nesting, given that they implement <a href="https://kotlinlang.org/api/latest/jvm/stdlib/kotlin/-auto-closeable/"><code>AutoCloseable</code></a>.</p>
<pre><code class="language-kotlin">resourceScope {
  val client = autoCloseable { HttpClient() }
  val api = autoCloseable { KtorPokemonTcgApi(client) }
  // now start the application
}
</code></pre>
<p>One step further is <a href="https://arrow-kt.io/ecosystem/suspendapp/">SuspendApp</a>, which adds graceful shutdown to the whole application. By combining <a href="https://arrow-kt.io/ecosystem/suspendapp/#suspendapp-arrows-resource">SuspendApp with Resource</a>, you can ensure that finalizers runs correctly, even when the application is terminated.</p>
<h3 id="pok√©-resources"><a class="header" href="#pok√©-resources">Pok√©-Resources</a></h3>
<p>Your <strong>task</strong> is to improve the current architecture of the application by introducing Resource and SuspendApp. Feel free to change the service constructors from the more implicit version provided to a more explicit version; for example, creating the <code>HttpClient</code> for <code>KtorPokemonTcpApi</code> explicitly.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="nicer-ui"><a class="header" href="#nicer-ui">Nicer UI</a></h1>
<blockquote>
<p><strong>Topics</strong>: Compose, navigation</p>
</blockquote>
<p>Compose Multiplatform is a great UI library based of functional principles. Although more tutorials and guides are slowly hitting the shelves, most of the material about Jetpack Compose (the Android version) still applies here. In this section we propose a couple of tasks in case you want to dive further in the UI side of things.</p>
<h2 id="better-search"><a class="header" href="#better-search">Better search</a></h2>
<p>Right now Pok√©-Fun only searches cards by name. However, the API has <a href="https://docs.pokemontcg.io/api-reference/cards/search-cards/">many more options</a>, so you can filter with respect to the different attributes in a card. For example, the player may want to look for cards of a specific type to build a thematic deck.</p>
<p>Your <strong>task</strong> is to provide an <em>advanced</em> search view (you can look at the <a href="https://www.pokemon.com/us/pokemon-tcg/pokemon-cards/">official card database</a> for inspiration). This requires changes in a few places:</p>
<ul>
<li>You have to extend <code>search</code> method in the <code>PokemonTcgApi</code> interface to take the additional information as input.</li>
<li>You have to modify the Ktor implementation to generate the correct query string.</li>
<li>You have to provide additional UI elements for the player to change the filters.</li>
</ul>
<p>To help with the UI side of things, the provided <code>Type</code> enumeration already contains the URL of the image corresponding to each of the types.</p>
<h2 id="card-detail-view"><a class="header" href="#card-detail-view">Card detail view</a></h2>
<p>Sometimes you may want to check the text on a card, but Pok√©-Fun does not make that easy, since the deck pane focuses on an <em>overview</em> of the deck. Your <strong>task</strong> is to add a way to show a detailed view; for example, when the card is (double) clicked.</p>
<p>We encourage you to use the <a href="https://www.jetbrains.com/help/kotlin-multiplatform-dev/compose-navigation-routing.html">navigation library</a> provided by Compose. To help you get started, we provide a very basic version in <code>deck/navigation.kt</code>. As you can see, navigation is done via <em>routes</em>, which are serializable classes representing a particular screen and data. Inside each of them, you define how the UI should look like, as we've been doing until now.</p>
<pre><code class="language-kotlin">composable&lt;Routes.Main&gt; {
  DeckPane(deck, modifier)
}
composable&lt;Routes.Detail&gt; { entry -&gt;
  // get the value of the argument
  val cardId = entry.toRoute&lt;Routes.Detail&gt;().cardId
  // build the UI from this information
}
</code></pre>
<div id="admonition-type-safe-routes" class="admonition admonish-info" role="note" aria-labelledby="admonition-type-safe-routes-title">
<div class="admonition-title">
<div id="admonition-type-safe-routes-title">
<p>Type safe routes</p>
</div>
<a class="admonition-anchor-link" href="cmp.html#admonition-type-safe-routes"></a>
</div>
<div>
<p>Versions of Compose Navigation prior to 2.8.0 (which corresponds to Compose Multiplatform 1.7.0) used strings instead of serializable objects to define routes. One more instance where <a href="https://developer.android.com/guide/navigation/design/type-safety">type safety</a> is a welcome addition.</p>
</div>
</div>
<h2 id="debouncing"><a class="header" href="#debouncing">Debouncing</a></h2>
<p>The current implementation initiates a search everytime the user types something in the corresponding field. In practice, though, people type a few characters in a row, so every connection before the last one is wasted time. Most applications implement <em>debouncing</em> as a strategy for providing good user experience but prevent needless work.</p>
<p>Your <strong>task</strong> is to apply that technique to Pok√©-Fun. There are several options to do so, <a href="https://xinkev.com/note/androiddev/debouncing-textfields-in-compose/">this guide</a> discusses the most straightforward ones in the context of Compose.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->
        <script src="./theme/mermaid.min.js"></script>
        <script src="./theme/mermaid-init.js"></script>

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </div>
    </body>
</html>